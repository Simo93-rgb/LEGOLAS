#!/bin/bash
# Script helper per training e evaluation con storie XES

# Colori
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}   LEGOLAS - Training & Evaluation Pipeline${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

# Verifica che i file di storie esistano
if [ ! -d "output/stories" ] || [ ! -f "output/stories/narrativo_train.pkl" ]; then
    echo -e "${RED}âŒ Errore: File di storie non trovati!${NC}"
    echo "   Esegui prima: ./run_xes_pipeline.sh"
    exit 1
fi

echo -e "${GREEN}âœ… File di storie trovati in output/${NC}\n"

# Menu scelta formato
echo -e "${YELLOW}Scegli il formato delle storie per il training:${NC}"
echo "  1) narrativo (raccomandato per BERT)"
echo "  2) bullet (formato compatto)"
echo "  3) clinical (con token clinici - sperimentale)"
echo ""
read -p "Scelta [1-3, default=1]: " choice

case $choice in
    2) FORMAT="bullet" ;;
    3) FORMAT="clinical" ;;
    *) FORMAT="narrativo" ;;
esac

echo -e "\n${GREEN}ðŸ“ Formato selezionato: ${FORMAT}${NC}\n"

# Aggiorna STORY_FORMAT in train_llm.py
echo -e "${BLUE}ðŸ“ Configurazione train_llm.py...${NC}"
sed -i "s/STORY_FORMAT = '.*'/STORY_FORMAT = '${FORMAT}'/" src/training/train_llm.py
echo -e "   âœ“ STORY_FORMAT = '${FORMAT}'"

# Aggiorna STORY_FORMAT in eval_model.py
echo -e "${BLUE}ðŸ“ Configurazione eval_model.py...${NC}"
sed -i "s/STORY_FORMAT = '.*'/STORY_FORMAT = '${FORMAT}'/" src/training/eval_model.py
echo -e "   âœ“ STORY_FORMAT = '${FORMAT}'"

# Menu scelta modello
echo -e "\n${YELLOW}Scegli il modello da usare:${NC}"
echo ""

# Usa script Python per caricare modelli da YAML
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MODEL_MENU=$("$SCRIPT_DIR/list_models.py" menu 2>/dev/null)

if [ $? -eq 0 ] && [ -n "$MODEL_MENU" ]; then
    # Menu dinamico da YAML
    echo -e "${GREEN}ðŸ“‹ Modelli disponibili da config/model_configs.yaml:${NC}"
    echo ""
    
    # Parse e display menu
    declare -a MODEL_IDS
    declare -a MODEL_DESCS
    i=0
    
    while IFS='|' read -r num model_id desc; do
        MODEL_IDS[$i]="$model_id"
        MODEL_DESCS[$i]="$desc"
        echo "  $num) $model_id"
        echo "      â””â”€ $desc"
        i=$((i+1))
    done <<< "$MODEL_MENU"
    
    MODEL_COUNT=$i
    echo ""
    read -p "Scelta [1-${MODEL_COUNT}, default=1]: " model_choice
    
    # Valida scelta
    if [[ "$model_choice" =~ ^[0-9]+$ ]] && [ "$model_choice" -ge 1 ] && [ "$model_choice" -le "$MODEL_COUNT" ]; then
        idx=$((model_choice - 1))
        MODEL="${MODEL_IDS[$idx]}"
    else
        # Default al primo
        MODEL="${MODEL_IDS[0]}"
    fi
    
    echo -e "\n${GREEN}ðŸ¤– Modello selezionato: ${MODEL}${NC}"
    
    # Mostra info modello
    MODEL_INFO=$("$SCRIPT_DIR/list_models.py" info "$MODEL" 2>/dev/null)
    if [ $? -eq 0 ]; then
        eval "$MODEL_INFO"
        echo -e "   HuggingFace: ${BLUE}${HF_ID}${NC}"
        echo -e "   Tipo: ${TYPE}"
        echo -e "   Batch consigliato: ${BATCH}"
        echo -e "   Learning rate: ${LR}"
    fi
    
else
    # Fallback a menu legacy
    echo -e "${YELLOW}âš ï¸  Config YAML non trovato, uso modelli legacy${NC}"
    echo ""
    echo "  1) bertm (BERT Medium - default)"
    echo "  2) roberta (RoBERTa Base)"
    echo "  3) cbert (Clinical BERT)"
    echo "  4) gpt2 (GPT-2)"
    echo ""
    read -p "Scelta [1-4, default=1]: " model_choice

    case $model_choice in
        2) MODEL="roberta" ;;
        3) MODEL="cbert" ;;
        4) MODEL="gpt2" ;;
        *) MODEL="bertm" ;;
    esac
    
    echo -e "\n${GREEN}ðŸ¤– Modello selezionato: ${MODEL}${NC}\n"
fi

# Aggiorna model_name in train_llm.py
sed -i "s/model_name = '.*'/model_name = '${MODEL}'/" src/training/train_llm.py

# Menu azione
echo -e "${YELLOW}Cosa vuoi fare?${NC}"
echo "  1) Solo training"
echo "  2) Solo evaluation (modello giÃ  addestrato)"
echo "  3) Training + Evaluation (completo)"
echo ""
read -p "Scelta [1-3, default=3]: " action

echo ""

case $action in
    1)
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${BLUE}   TRAINING${NC}"
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        uv run python src/training/train_llm.py
        ;;
    2)
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${BLUE}   EVALUATION${NC}"
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        # Aggiorna anche eval_model.py con il modello scelto
        sed -i "s/model_name = '.*'/model_name = '${MODEL}'/" src/training/eval_model.py
        uv run python src/training/eval_model.py
        ;;
    *)
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${BLUE}   TRAINING${NC}"
        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        uv run python src/training/train_llm.py
        
        if [ $? -eq 0 ]; then
            echo -e "\n${GREEN}âœ… Training completato!${NC}\n"
            echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo -e "${BLUE}   EVALUATION${NC}"
            echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
            
            # Aggiorna anche eval_model.py con il modello scelto
            sed -i "s/model_name = '.*'/model_name = '${MODEL}'/" src/training/eval_model.py
            uv run python src/training/eval_model.py
            
            if [ $? -eq 0 ]; then
                echo -e "\n${GREEN}âœ… Evaluation completato!${NC}"
                echo -e "\nðŸ“Š Risultati salvati in: ${GREEN}prediction/xes_${FORMAT}_${MODEL}_*${NC}"
            fi
        else
            echo -e "\n${RED}âŒ Errore durante il training${NC}"
            exit 1
        fi
        ;;
esac

echo -e "\n${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ… Operazione completata!${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

# Mostra file generati
if [ -d "prediction" ]; then
    echo "ðŸ“ File generati:"
    ls -lh prediction/xes_${FORMAT}_${MODEL}_* 2>/dev/null || echo "   (nessun file ancora)"
    echo ""
fi

echo -e "${YELLOW}ðŸ’¡ Suggerimenti:${NC}"
echo "   - Modello salvato in: output/models/xes_${FORMAT}_${MODEL}.pth"
echo "   - Report in: prediction/xes_${FORMAT}_${MODEL}_report.txt"
echo "   - Per provare altro formato: esegui di nuovo questo script"
